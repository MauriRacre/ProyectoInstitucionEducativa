<ng-container *ngIf="open">
  <div class="fixed inset-0 z-[2000]">
    <div class="absolute inset-0 bg-black/40" (click)="onBackdrop()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-xl">
        <!-- Header -->
        <div class="flex items-start justify-between gap-3 border-b border-gray-100 px-6 py-5">
          <div>
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">
              {{ mode === 'edit'? 'Editar Tutor y Estudiante(s)' : 'Registrar Tutor y Estudiante(s)'}}
            </h2>
          </div>

          <button
            type="button"
            class="rounded-lg p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-600/30"
            (click)="onCancel()"
            [disabled]="loading"
            aria-label="Cerrar"
          >
            ✕
          </button>
        </div>

        <!-- Body -->
        <form (ngSubmit)="onSubmit()" [formGroup]="form" class="max-h-[70vh] overflow-y-auto px-6 py-5">
          <!-- Parent -->
          <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4 sm:p-5">
            <div class="flex flex-col items-start">
                <h3 class="text-base font-semibold text-black">Datos del Tutor</h3>
                <p class="text-sm text-gray-500">Ingrese la información básica del tutor para el sistema.</p>
            </div>

            <div formGroupName="parent" class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-3">
              <!-- Name -->
              <div class="sm:col-span-1">
                <label class="text-xs font-semibold text-gray-700">Nombre Completo</label>
                <input
                  type="text"
                  formControlName="name"
                  placeholder="Ej: Carlos Pérez"
                  class="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                />
                <p *ngIf="c('parent.name')?.touched && c('parent.name')?.invalid" class="mt-1 text-xs text-red-600">
                  Nombre requerido (mín. 3).
                </p>
              </div>

              <!-- Email -->
              <div class="sm:col-span-1">
                <label class="text-xs font-semibold text-gray-700">Correo electrónico</label>
                <input
                  type="email"
                  formControlName="email"
                  placeholder="Ej: carlos@mail.com"
                  class="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                />
                <p *ngIf="c('parent.email')?.touched && c('parent.email')?.invalid" class="mt-1 text-xs text-red-600">
                  Correo válido requerido.
                </p>
              </div>

              <!-- Phone -->
              <div class="sm:col-span-1">
                <label class="text-xs font-semibold text-gray-700">Celular</label>
                <input
                  type="tel"
                  formControlName="phone"
                  placeholder="Ej: 74123456"
                  class="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                />
                <p *ngIf="c('parent.phone')?.touched && c('parent.phone')?.invalid" class="mt-1 text-xs text-red-600">
                  Celular requerido.
                </p>
              </div>
            </div>
          </div>

          <!-- Students -->
          <div class="mt-5">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div class="ml-5">
                <h3 class="text-base font-semibold text-gray-900">Estudiantes</h3>
                <p class="text-sm text-gray-500">Puedes agregar más de un estudiante para el mismo papá.</p>
              </div>

              <button
                type="button"
                (click)="addStudent()"
                class="inline-flex items-center justify-center gap-2r rounded-lg bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600/30"
                [disabled]="loading"
              >
                + Agregar estudiante
              </button>
            </div>

            <div formArrayName="students" class="mt-4 space-y-4">
              <div
                *ngFor="let s of students.controls; let i = index"
                [formGroupName]="i"
                class="rounded-2xl border border-gray-200 bg-white p-4 sm:p-5"
              >
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <div class="text-xs font-semibold text-gray-500">Estudiante {{ i + 1 }}</div>
                        <div class="text-sm font-semibold text-gray-900">Datos del estudiante</div>
                    </div>

                    <button
                        type="button"
                        (click)="removeStudent(i)"
                        class="rounded-md border border-red-600 bg-white p-1 font-semibold text-red-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        [disabled]="loading || students.length <= 1"
                        title="Eliminar estudiante"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor">
                            <path d="M232.7 69.9C237.1 56.8 249.3 48 263.1 48L377 48C390.8 48 403 56.8 407.4 69.9L416 96L512 96C529.7 96 544 110.3 544 128C544 145.7 529.7 160 512 160L128 160C110.3 160 96 145.7 96 128C96 110.3 110.3 96 128 96L224 96L232.7 69.9zM128 208L512 208L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 208zM216 272C202.7 272 192 282.7 192 296L192 488C192 501.3 202.7 512 216 512C229.3 512 240 501.3 240 488L240 296C240 282.7 229.3 272 216 272zM320 272C306.7 272 296 282.7 296 296L296 488C296 501.3 306.7 512 320 512C333.3 512 344 501.3 344 488L344 296C344 282.7 333.3 272 320 272zM424 272C410.7 272 400 282.7 400 296L400 488C400 501.3 410.7 512 424 512C437.3 512 448 501.3 448 488L448 296C448 282.7 437.3 272 424 272z"/>
                        </svg>                  
                    </button>
                </div>

                <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-6">
                  <!-- Student name -->
                  <div class="sm:col-span-3">
                    <label class="text-xs font-semibold text-gray-700">Nombre Completo</label>
                    <input
                      type="text"
                      formControlName="name"
                      placeholder="Ej: Juan Pérez"
                      class="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                    />
                    <p *ngIf="studentAt(i).get('name')?.touched && studentAt(i).get('name')?.invalid"
                        class="mt-1 text-xs text-red-600">
                      Nombre requerido.
                    </p>
                  </div>

                  <!-- Grade -->
                  <div class="sm:col-span-2">
                    <label class="text-xs font-semibold text-gray-700">Grado</label>
                    <select
                      formControlName="grade"
                      class="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                    >
                      <option *ngFor="let g of grades" [value]="g">{{ g }}</option>
                    </select>
                  </div>

                  <!-- Parallel -->
                  <div class="sm:col-span-1">
                    <label class="text-xs font-semibold text-gray-700">Paralelo</label>
                    <select
                      formControlName="parallel"
                      class="mt-1 w-full rounded-lg border border-gray-200 bg-white px-3 py-2.5 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
                    >
                      <option *ngFor="let p of parallels" [value]="p">{{ p }}</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- Footer -->
        <div class="flex items-center justify-end gap-2 border-t border-gray-100 bg-gray-50 px-6 py-4">
          <button
            type="button"
            class="w-28 rounded-lg bg-white px-4 py-2 text-sm font-semibold text-gray-800 border border-gray-200 hover:bg-gray-100"
            (click)="onCancel()"
            [disabled]="loading"
          >
            Cancelar
          </button>

          <button
            type="submit"
            class="w-28 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"
            (click)="onSubmit()"
            [disabled]="loading"
          >
            {{ loading ? 'Guardando…' : (mode === 'edit' ? 'Guardar' :'Registrar') }}
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-container>
