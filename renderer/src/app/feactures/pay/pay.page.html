 <div class="min-h-screen bg-gray-50">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header -->
    <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <div class="text-2xl sm:text-3xl font-semibold text-gray-900 flex items-center gap-2">
          <a type="button" href="/" class="text-gray-900 hover:text-gray-300 hover:bg-white rounded-xl p-2 hover:shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="w-7"><path d="M201.4 297.4C188.9 309.9 188.9 330.2 201.4 342.7L361.4 502.7C373.9 515.2 394.2 515.2 406.7 502.7C419.2 490.2 419.2 469.9 406.7 457.4L269.3 320L406.6 182.6C419.1 170.1 419.1 149.8 406.6 137.3C394.1 124.8 373.8 124.8 361.3 137.3L201.3 297.3z"/></svg>
          </a>
          Procesar Pago Detallado
        </div>
        <p class="text-sm text-gray-500">Gestión de cobros y abonos parciales</p>
      </div>

      <button
        type="button"
        (click)="openModalAbono()"
        class="inline-flex items-center justify-center gap-2 rounded-xl bg-celeste px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-azul"
      >
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14M5 12h14"/>
        </svg>
        Abono
      </button>
    </div>
    <!--Modal abono-->
    <app-modal-abono
      [open]="showModalAbono"
      (closed)="closeModalAbono()"
      (saved)="onSaved($event)"
    ></app-modal-abono>
    <!--Modal Edit-->
    <app-modal-register
        [open]="showModalEdit"
        [mode]="mode"
        [value]="editValue"
        
        (close)="closeModalEdit()"
        (submitForm)="onSavedEdit($event)"
    ></app-modal-register>
    <!-- Layout -->
    <div class="mt-6 grid grid-cols-1 gap-4 lg:grid-cols-12">

      <!-- LEFT -->
      <div class="lg:col-span-9 space-y-4">

        <!-- Tutor card -->
        <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
            <div>
              <div class="flex gap-1 items-center">
                <h2 class="text-base font-semibold text-gray-900">{{ tutor.name }}</h2>
                <button
                  type="button"
                  (click)="openModalEdit()"
                  class="text-gray-900 hover:bg-gray-100 rounded-xl p-2 hover:text-gray-700"
                  >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" class="w-4">
                    <path d="M505 122.9L517.1 135C526.5 144.4 526.5 159.6 517.1 168.9L488 198.1L441.9 152L471 122.9C480.4 113.5 495.6 113.5 504.9 122.9zM273.8 320.2L408 185.9L454.1 232L319.8 366.2C316.9 369.1 313.3 371.2 309.4 372.3L250.9 389L267.6 330.5C268.7 326.6 270.8 323 273.7 320.1zM437.1 89L239.8 286.2C231.1 294.9 224.8 305.6 221.5 317.3L192.9 417.3C190.5 425.7 192.8 434.7 199 440.9C205.2 447.1 214.2 449.4 222.6 447L322.6 418.4C334.4 415 345.1 408.7 353.7 400.1L551 202.9C579.1 174.8 579.1 129.2 551 101.1L538.9 89C510.8 60.9 465.2 60.9 437.1 89zM152 128C103.4 128 64 167.4 64 216L64 488C64 536.6 103.4 576 152 576L424 576C472.6 576 512 536.6 512 488L512 376C512 362.7 501.3 352 488 352C474.7 352 464 362.7 464 376L464 488C464 510.1 446.1 528 424 528L152 528C129.9 528 112 510.1 112 488L112 216C112 193.9 129.9 176 152 176L264 176C277.3 176 288 165.3 288 152C288 138.7 277.3 128 264 128L152 128z"/>
                  </svg>
                </button>
              </div>

              <div class="mt-2 flex flex-col gap-2 text-sm text-gray-600 sm:flex-row sm:items-center sm:gap-4">
                <div class="flex items-center gap-2">
                  <svg class="h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor">
                    <path d="M144 128C144 92.7 172.7 64 208 64L432 64C467.3 64 496 92.7 496 128L496 512C496 547.3 467.3 576 432 576L208 576C172.7 576 144 547.3 144 512L144 128zM208 128L208 432L432 432L432 128L208 128zM320 536C337.7 536 352 521.7 352 504C352 486.3 337.7 472 320 472C302.3 472 288 486.3 288 504C288 521.7 302.3 536 320 536z"/>
                  </svg>
                  <span>{{ tutor.phone }}</span>
                </div>

                <div class="flex items-center gap-2">
                  <svg class="h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor">
                    <path d="M125.4 128C91.5 128 64 155.5 64 189.4C64 190.3 64 191.1 64.1 192L64 192L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 192L575.9 192C575.9 191.1 576 190.3 576 189.4C576 155.5 548.5 128 514.6 128L125.4 128zM528 256.3L528 448C528 456.8 520.8 464 512 464L128 464C119.2 464 112 456.8 112 448L112 256.3L266.8 373.7C298.2 397.6 341.7 397.6 373.2 373.7L528 256.3zM112 189.4C112 182 118 176 125.4 176L514.6 176C522 176 528 182 528 189.4C528 193.6 526 197.6 522.7 200.1L344.2 335.5C329.9 346.3 310.1 346.3 295.8 335.5L117.3 200.1C114 197.6 112 193.6 112 189.4z"/>
                  </svg>
                  <span>{{ tutor.email }}</span>
                </div>
              </div>
            </div>

            <div class="text-xs text-gray-500">
              <div class="font-semibold text-gray-900">Total pendiente</div>
              <div class="mt-1 text-lg font-bold" [ngClass]="totals.pending > 0 ? 'text-red-700' : 'text-emerald-700'">
                Bs. {{ totals.pending | number:'1.2-2' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Children -->
        <div *ngFor="let child of children; trackBy: trackByChildId" class="space-y-2">
          <div class="flex items-center gap-2">
            <svg class="h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor">
              <path d="M240 192C240 147.8 275.8 112 320 112C364.2 112 400 147.8 400 192C400 236.2 364.2 272 320 272C275.8 272 240 236.2 240 192zM448 192C448 121.3 390.7 64 320 64C249.3 64 192 121.3 192 192C192 262.7 249.3 320 320 320C390.7 320 448 262.7 448 192zM144 544C144 473.3 201.3 416 272 416L368 416C438.7 416 496 473.3 496 544L496 552C496 565.3 506.7 576 520 576C533.3 576 544 565.3 544 552L544 544C544 446.8 465.2 368 368 368L272 368C174.8 368 96 446.8 96 544L96 552C96 565.3 106.7 576 120 576C133.3 576 144 565.3 144 552L144 544z"/>
            </svg>
            <h3 class="text-base font-semibold text-gray-900">{{ child.name }}</h3>
            <span class="text-sm text-gray-500">{{ child.grade }} - {{ child.parallel }}</span>
          </div>

          <!-- Table -->
          <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm">
            <div class="overflow-x-auto">
              <table class="min-w-full text-left text-sm">
                <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-600">
                  <tr>
                    <th class="px-5 py-3"><span class="sr-only">Seleccionar</span></th>
                    <th class="px-5 py-3">Concepto</th>
                    <th class="px-5 py-3">Total</th>
                    <th class="px-5 py-3">Pagado</th>
                    <th class="px-5 py-3">Pendiente</th>
                    <th class="px-5 py-3">Descuento</th>
                    <th class="px-5 py-3">Monto a pagar</th>
                    <th class="px-5 py-3 text-right">Historial</th>
                  </tr>
                </thead>

                <tbody class="divide-y divide-gray-100">
                  <ng-container *ngFor="let p of pagedPayments(child.id); trackBy: trackByPaymentId">

                    <!-- Main row -->
                    <tr class="hover:bg-gray-50/70">
                      <!-- Select -->
                      <td class="px-5 py-4">
                        <input
                          type="checkbox"
                          class="h-4 w-4 rounded border-gray-300 text-sky-700 focus:ring-sky-600"
                          [checked]="isSelected(p.id)"
                          (change)="toggleSelected(p)"
                          [disabled]="p.pending <= 0"
                        />
                      </td>

                      <!-- Concept -->
                      <td class="px-5 py-4">
                        <div class="font-semibold text-gray-900">{{ p.concept }}</div>
                        <div class="text-xs text-gray-500">ID: {{ p.id }}</div>
                      </td>

                      <!-- Total -->
                      <td class="px-5 py-4">
                        <div class="font-semibold text-gray-900">Bs. {{ p.amountTotal | number:'1.2-2' }}</div>
                      </td>

                      <!-- Paid -->
                      <td class="px-5 py-4">
                        <div class="font-semibold text-gray-900">
                          Bs. {{ paid(p) | number:'1.2-2' }}
                        </div>
                      </td>

                      <!-- Pending -->
                      <td class="px-5 py-4">
                        <span
                          class="inline-flex rounded-xl border px-3 py-2 text-sm font-semibold"
                          [ngClass]="p.pending > 0 ? 'border-red-200 bg-red-50 text-red-700' : 'border-gray-200 bg-gray-50 text-gray-500'"
                        >
                          Bs. {{ p.pending | number:'1.2-2' }}
                        </span>
                      </td>

                      <!-- Discount -->
                      <td class="px-5 py-4">
                        <div class="flex items-center gap-2">
                          <span class="text-gray-500">Bs.</span>
                          <input
                            type="number"
                            min="0"
                            [max]="p.pending"
                            class="w-24 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-sky-600 focus:ring-2 focus:ring-sky-600/20"
                            [value]="draftDiscount[p.id] ?? 0"
                            (input)="setDiscount(p.id, $any($event.target).value)"
                            [disabled]="p.pending <= 0"
                          />
                        </div>
                        <p class="mt-1 text-xs text-gray-400">Máx: Bs. {{ p.pending | number:'1.2-2' }}</p>
                      </td>

                      <!-- Pay -->
                      <td class="px-5 py-4">
                        <div class="flex items-center gap-2">
                          <span class="text-celeste font-semibold">Bs.</span>
                          <input
                            type="number"
                            min="0"
                            [max]="maxPayFor(p)"
                            class="w-24 rounded-xl border border-sky-200 bg-white px-3 py-2 text-sm outline-none focus:border-sky-600 focus:ring-2 focus:ring-sky-600/20"
                            [value]="draftPay[p.id] ?? 0"
                            (input)="setPay(p.id, $any($event.target).value)"
                            [disabled]="p.pending <= 0"
                          />
                        </div>
                        <p class="mt-1 text-xs text-gray-400">Máx: Bs. {{ maxPayFor(p) | number:'1.2-2' }}</p>
                      </td>

                      <!-- History toggle -->
                      <td class="px-5 py-4">
                        <div class="flex justify-end">
                          <button
                            type="button"
                            (click)="toggleHistory(p.id)"
                            class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-700 hover:bg-gray-50"
                          >
                            {{ isHistoryOpen(p.id) ? 'Ocultar' : 'Ver' }}
                            <span class="ml-1 text-gray-400">({{ p.history?.length ?? 0 }})</span>
                          </button>
                        </div>
                      </td>
                    </tr>

                    <!-- Expandable history -->
                    <tr *ngIf="isHistoryOpen(p.id)" class="bg-gray-50/60">
                      <td colspan="9" class="px-5 py-4">
                        <div class="rounded-2xl border border-gray-200 bg-white p-4">
                          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                            <div class="text-sm font-semibold text-gray-900">Historial de pagos</div>
                            <div class="flex items-center gap-3">
                              <div class="h-2 w-28 rounded-full bg-gray-100 overflow-hidden">
                                <div
                                  class="h-full rounded-full"
                                  [ngClass]="progressPct(p) >= 100 ? 'bg-verde' : 'bg-celeste'"
                                  [style.width.%]="progressPct(p)"
                                ></div>
                              </div>

                              <span class="text-xs font-semibold text-gray-600">
                                {{ progressPct(p) | number:'1.0-0' }}%
                              </span>

                              <span
                                class="inline-flex rounded-full px-2 py-0.5 text-xs font-semibold border"
                                [ngClass]="statusClass(p)"
                              >
                                {{ statusLabel(p) }}
                              </span>
                            </div>
                          </div>

                          <div class="mt-3 space-y-2">
                            <div
                              *ngFor="let h of p.history;let i = index; trackBy: trackByHistoryId"
                              class="flex flex-col gap-1 rounded-xl border border-gray-100 bg-gray-50 p-3 sm:flex-row sm:items-center sm:justify-between"
                            >
                              <div class="min-w-0">
                                <div class="text-sm font-semibold text-gray-900">
                                  {{ formatDate(h.dateISO) }} · {{ h.conceptLabel }}
                                </div>
                                <div class="text-xs text-gray-500" *ngIf="h.note">{{ h.note }}</div>
                              </div>

                              <div class="flex items-center gap-3 text-sm">
                                <span class="font-semibold text-celeste">+ Bs. {{ h.paid | number:'1.2-2' }}</span>
                                <span class="font-semibold text-verde" *ngIf="h.discount > 0">
                                  - Bs. {{ h.discount | number:'1.2-2' }}
                                </span>
                                <span class="text-xs text-gray-500">
                                  de Bs. {{ p.amountTotal | number:'1.2-2' }}
                                </span>
                                <button
                                  *ngIf="i === 0 && !h.reverted"
                                  type="button"
                                  (click)="revertLastMovement(p)"
                                  class="ml-2 rounded-lg border border-red-200 bg-white px-2.5 py-1.5 text-xs font-semibold text-rojo hover:bg-red-50"
                                  title="Revertir último movimiento"
                                >
                                  Revertir
                                </button>
                                <span *ngIf="h.reverted" class="ml-2 text-xs font-semibold text-gray-500">
                                  (revertido)
                                </span>
                              </div>
                            </div>

                            <div *ngIf="!p.history?.length" class="text-sm text-gray-500">
                              No hay pagos registrados para este concepto.
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>

                  </ng-container>

                  <!-- Empty state -->
                  <tr *ngIf="paymentsByChild[child.id]?.length === 0">
                    <td colspan="9" class="px-5 py-10 text-center">
                      <div class="text-sm font-semibold text-gray-900">No se encontraron pagos.</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="flex flex-col gap-3 border-t border-gray-100 bg-white px-5 py-4 sm:flex-row sm:items-center sm:justify-between">
              <div class="text-sm text-gray-600">
                Mostrando
                <span class="font-semibold text-gray-900">{{ childPageStart(child.id) + 1 }}</span>
                –
                <span class="font-semibold text-gray-900">{{ childPageEnd(child.id) }}</span>
                de
                <span class="font-semibold text-gray-900">{{ paymentsByChild[child.id]?.length ?? 0 }}</span>
              </div>

              <nav class="flex items-center gap-1" aria-label="Pagination">
                <button
                  type="button"
                  (click)="goToChildPage(child.id, childPage[child.id] - 1)"
                  [disabled]="childPage[child.id] === 1"
                  class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40"
                >
                  ‹
                </button>

                <ng-container *ngFor="let pg of visiblePages(child.id)">
                  <button
                    *ngIf="pg !== '...'; else dots"
                    type="button"
                    (click)="goToChildPage(child.id, pg)"
                    class="h-9 w-9 rounded-lg text-sm font-semibold transition"
                    [ngClass]="pg === childPage[child.id]
                      ? 'bg-gray-900 text-white'
                      : 'border border-gray-200 bg-white text-gray-700 hover:bg-gray-50'"
                  >
                    {{ pg }}
                  </button>
                  <ng-template #dots>
                    <span class="px-2 text-gray-400">…</span>
                  </ng-template>
                </ng-container>

                <button
                  type="button"
                  (click)="goToChildPage(child.id, childPage[child.id] + 1)"
                  [disabled]="childPage[child.id] === childTotalPages(child.id)"
                  class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40"
                >
                  ›
                </button>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="lg:col-span-3">
        <div class="sticky top-6 space-y-3 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-base font-semibold text-gray-900">Resumen de Pago</div>
              <div class="text-sm text-gray-500">Selecciona conceptos.</div>
            </div>
            <div class="h-10 w-10 text-celeste flex items-center justify-center font-bold">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" class="w-8">
                <path d="M128 96C92.7 96 64 124.7 64 160L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 256C576 220.7 547.3 192 512 192L136 192C122.7 192 112 181.3 112 168C112 154.7 122.7 144 136 144L520 144C533.3 144 544 133.3 544 120C544 106.7 533.3 96 520 96L128 96zM480 320C497.7 320 512 334.3 512 352C512 369.7 497.7 384 480 384C462.3 384 448 369.7 448 352C448 334.3 462.3 320 480 320z"/>
              </svg>
            </div>
          </div>

          <div class="mt-2 space-y-2 rounded-2xl border border-gray-100 bg-gray-50 p-4">
            <div class="flex items-center justify-between text-sm">
              <div class="text-gray-600 font-semibold">Conceptos seleccionados</div>
              <div class="font-semibold text-gray-900">{{ selectedCount }}</div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <div class="text-gray-600 font-semibold">Total deuda (seleccionados)</div>
              <div class="font-semibold text-gray-900">Bs. {{ totals.selectedTotal | number:'1.2-2' }}</div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <div class="text-gray-600 font-semibold">Descuentos</div>
              <div class="font-semibold text-verde">- Bs. {{ totals.discounts | number:'1.2-2' }}</div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <div class="text-gray-600 font-semibold">Pendiente (seleccionados)</div>
              <div class="font-semibold text-rojo">Bs. {{ totals.selectedPending | number:'1.2-2' }}</div>
            </div>

            <div class="h-px bg-gray-200 my-2"></div>

            <div class="flex items-center justify-between">
              <div class="font-semibold text-gray-900">Total a cobrar</div>
              <div class="text-lg font-bold text-gray-900">Bs. {{ totals.toCharge | number:'1.2-2' }}</div>
            </div>
          </div>

          <button
            type="button"
            (click)="confirmPayment()"
            [disabled]="selectedCount === 0 || totals.toCharge <= 0"
            class="mt-2 inline-flex w-full items-center justify-center gap-2 rounded-xl text-white bg-celeste px-4 py-3 text-sm font-semibold hover:bg-azul disabled:cursor-not-allowed disabled:opacity-50"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" class="w-5">
              <path d="M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM438 209.7C427.3 201.9 412.3 204.3 404.5 215L285.1 379.2L233 327.1C223.6 317.7 208.4 317.7 199.1 327.1C189.8 336.5 189.7 351.7 199.1 361L271.1 433C276.1 438 282.9 440.5 289.9 440C296.9 439.5 303.3 435.9 307.4 430.2L443.3 243.2C451.1 232.5 448.7 217.5 438 209.7z"/>
            </svg>
            Confirmar Pago
          </button>

          <p class="text-xs text-gray-500 text-center">
            Se genera una notificación automática que se enviará por email al Tutor.
          </p>
        </div>
      </aside>

    </div>
  </div>
</div>
